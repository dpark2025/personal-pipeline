# 🚨 Test Suite Instability: Multiple Failures in `npm run test`

## Title
Investigate and resolve recurring test failures in CI/local environment

## Priority
High (Blocker for releases and PR merges)

## Severity
High

## Status
🔄 Open – Investigation in Progress

## Description
The test suite (`npm run test`) is consistently failing across multiple test files, with **11 test suites failing and 14 individual tests failing** (out of 30 total). Failures are scattered across different modules, including:
- Network error scenarios
- Cache service metrics
- Performance monitoring

This indicates a **widespread test instability issue**, not just a single bug. Failures are occurring locally and in CI, suggesting a regression in test setup, environment, or underlying logic.

## Symptoms
- `npm run test` fails with:
  - `Expected: >= 25, Received: 0` (cache stats)
  - `metrics.response_times.count = 0` (performance monitoring)
  - Other intermittent or deterministic failures in error scenarios
- Test suite takes ~7.5 seconds and fails consistently
- No recent feature changes linked to test suite — suggests potential regression

## Root Cause Hypothesis
- Test environment (`testEnv`) may be improperly initialized (e.g., cache or performance monitor not mocked correctly)
- Mocks or spies are not being reset between tests
- Side effects in test setup (e.g., global state, timers, or network mocks) are leaking across test files
- Possible change in test runner behavior (e.g., Jest configuration, version mismatch)

## Files Affected
- `tests/error-scenarios/network-issues.test.ts` (multiple failures)
- `src/services/cache.service.ts`
- `src/metrics/performance-monitor.ts`
- `src/utils/test-env.ts`
- `jest.config.js` / `jest.setup.js`
- `package.json` (check `jest` version and `test` script)

## Impact
- **Blocks all PRs** from being merged
- **Delays release** due to unstable test suite
- **Reduces developer confidence** in test results
- **Wastes time** debugging false positives or flaky behavior

## Assign to
Test Infrastructure Lead ()
+ DevOps / QA Team (for cross-functional review)

## Resolution Plan
1. 🔍 **Audit test environment setup**:
   - Verify `testEnv` is reset between tests
   - Check for global state, timers, or network mocks
2. 🧹 **Refactor test setup**:
   - Use `beforeEach()` to reset mocks
   - Avoid global test state
3. 🛠️ **Update Jest config**:
   - Ensure `clearMocks`, `restoreMocks`, and `resetModules` are enabled
   - Check for version mismatch (e.g., Jest 29 vs 30)
4. 📊 **Add test flakiness logging**:
   - Run tests with `--detectOpenHandles` and `--runInBand`
   - Log test execution order and environment state
5. 🧪 **Run test suite in isolation**:
   - Try running one test file at a time
   - Identify if failures are isolated or systemic

## Verification
After fix:
- ✅ `npm run test` passes **100%** (0 failed, 0 skipped)
- ✅ All tests pass **locally and in CI**
- ✅ No `ReferenceError`, `undefined`, or `0` vs `expected` failures in metrics or cache
- ✅ Test suite runs in under 8 seconds consistently

## Additional Context
This is not just a bug — it’s a **test quality and engineering hygiene issue**. A flaky or unstable test suite erodes trust in the pipeline. We must treat test reliability as a **first-class engineering goal**, not a side effect.

> 🔎 **Pro Tip**: Consider adding a `test:lint` or `test:stability` script to monitor test health over time.

