#!/bin/sh
#
# Pre-commit hook for Personal Pipeline MCP Server
# Runs TypeScript compiler checks, ESLint, and tests before allowing commit
#
# This hook was automatically generated to ensure code quality.
# To bypass this hook temporarily, use: git commit --no-verify
#

set -e

echo "🔍 Running pre-commit checks..."

# Check if we're in a git repository (works with worktrees)
if ! git rev-parse --git-dir >/dev/null 2>&1; then
  echo "❌ Error: Not in a git repository"
  exit 1
fi

# Check if package.json exists
if [ ! -f package.json ]; then
  echo "❌ Error: package.json not found"
  exit 1
fi

# Function to print colored output
print_step() {
  echo "\n🔧 $1..."
}

print_success() {
  echo "✅ $1"
}

print_error() {
  echo "❌ $1"
}

# Step 1: TypeScript compiler checks
print_step "Running TypeScript compiler checks"
if npm run typecheck >/dev/null 2>&1; then
  print_success "TypeScript checks passed"
else
  print_error "TypeScript checks failed"
  echo "Please fix TypeScript errors before committing."
  echo "Run: npm run typecheck"
  npm run typecheck
  exit 1
fi

# Step 2: ESLint checks
print_step "Running ESLint"
if npm run lint >/dev/null 2>&1; then
  print_success "ESLint checks passed"
else
  print_error "ESLint checks failed"
  echo "Please fix linting errors before committing."
  echo "Run: npm run lint:fix"
  npm run lint
  exit 1
fi

# Step 3: Run tests
print_step "Running tests"
if npm test >/dev/null 2>&1; then
  print_success "All tests passed"
else
  print_error "Tests failed"
  echo "Please fix failing tests before committing."
  echo "Run: npm test"
  npm test
  exit 1
fi

# All checks passed
echo "\n🎉 All pre-commit checks passed! Proceeding with commit..."